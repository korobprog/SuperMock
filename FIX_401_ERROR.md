# Исправление ошибки 401 (Unauthorized) в продакшене

## Проблема

После выбора языка в продакшн версии возникала ошибка:

```
POST https://api.supermock.ru/api/init 401 (Unauthorized)
```

## Причина

В продакшене приложение не запускается в контексте Telegram WebApp, поэтому `window.Telegram?.WebApp` возвращает `null`. Код пытался отправить запрос без правильных данных аутентификации.

## Решение

### 1. Улучшена логика аутентификации через Telegram Login Widget

- Исправлена логика проверки аутентифицированных пользователей в `LanguageSelection.tsx`
- Добавлено детальное логирование для отладки
- Убрана зависимость от demo режима для продакшена

### 2. Отключен Demo режим в продакшене

- Установлено `ENABLE_DEMO_MODE=0` и `VITE_ENABLE_DEMO_MODE=0` в `production.env`
- Теперь используется только реальная аутентификация через Telegram Login Widget

### 3. Улучшена обработка ошибок

- В `api.ts` добавлено детальное логирование ошибок API
- В `LanguageSelection.tsx` добавлена try-catch обработка с перенаправлением на профиль
- Добавлена отладочная информация в dev режиме

## Файлы изменены

### Backend

- `production.env` - отключен demo режим
- `backend/server/index.js` - добавлено дополнительное логирование

### Frontend

- `frontend/src/pages/LanguageSelection.tsx` - улучшена логика аутентификации
- `frontend/src/lib/api.ts` - улучшена обработка ошибок
- `frontend/src/env.d.ts` - добавлена типизация для переменной

## Развертывание

### Вариант 1: Перезапуск с пересборкой

```bash
# Остановить текущие контейнеры
docker-compose -f docker-compose.prod.yml down

# Пересобрать и запустить с новыми переменными
docker-compose -f docker-compose.prod.yml up -d --build
```

### Вариант 2: Использовать скрипт для реальной аутентификации

```bash
chmod +x restart-prod-real-auth.sh
./restart-prod-real-auth.sh
```

## Инструкции для пользователей

### Для тестирования в продакшене:

1. Откройте https://supermock.ru
2. Нажмите "Войти" для аутентификации через Telegram Login Widget
3. После успешной аутентификации выберите язык
4. Должно работать без ошибок 401

### Для разработчиков:

- В dev режиме доступна отладочная информация на странице выбора языка
- Demo режим работает только в development окружении
- В продакшене используется только реальная аутентификация через Telegram

## Отладка

Если проблема все еще возникает:

1. **Проверьте аутентификацию:**

   - Убедитесь, что вы вошли через Telegram Login Widget
   - Проверьте консоль браузера на наличие ошибок

2. **Проверьте логи сервера:**

   ```bash
   docker-compose -f docker-compose.prod.yml logs backend
   ```

3. **Проверьте переменные окружения:**
   - Убедитесь, что `ENABLE_DEMO_MODE=0` в production.env
   - Проверьте, что `TELEGRAM_BOT_TOKEN` установлен правильно

## Альтернативные решения

Если нужен demo режим в продакшене:

1. Включить demo режим: `ENABLE_DEMO_MODE=1` и `VITE_ENABLE_DEMO_MODE=1`
2. Использовать скрипт `restart-prod.sh` вместо `restart-prod-real-auth.sh`
