# Система персонализированных ссылок для матчинга

## Обзор

Реализована система персонализированных ссылок для моковых собеседований, которая позволяет участникам получать уникальные ссылки на комнату ожидания и обеспечивает безопасный доступ к сессиям.

## Основные компоненты

### 1. Страница ожидания (`/waiting/:sessionId`)

**Файл:** `frontend/src/pages/WaitingRoom.tsx`

**Функциональность:**

- ✅ Проверка авторизации пользователя для конкретной сессии
- ✅ Отображение информации о сессии (время, роль, профессия, язык)
- ✅ Таймер обратного отсчета до начала интервью
- ✅ Прогресс-бар до возможности входа (за 5 минут до начала)
- ✅ Кнопка "Войти досрочно" для тестирования
- ✅ Автоматическое перенаправление в интервью при готовности

**Безопасность:**

- Только участники сессии могут получить доступ
- Проверка userId на бэкенде
- Автоматическое перенаправление при неавторизованном доступе

### 2. API для получения сессии

**Endpoint:** `GET /api/session/:sessionId`

**Файл:** `backend/server/index.js`

**Функциональность:**

- ✅ Получение данных сессии по ID
- ✅ Проверка авторизации пользователя
- ✅ Возврат только необходимых полей
- ✅ Обработка ошибок (404, 403)

### 3. Обновленная логика матчинга

**Файл:** `backend/server/index.js` (функция `attemptQueueMatch`)

**Изменения:**

- ✅ Генерация персонализированных ссылок для каждого участника
- ✅ Включение ссылок в Telegram уведомления
- ✅ Обновление real-time уведомлений с ссылками

### 4. Обновленная страница интервью

**Файл:** `frontend/src/pages/Interview.tsx`

**Новые возможности:**

- ✅ Поддержка sessionId из URL параметров
- ✅ Автоматическая загрузка данных сессии
- ✅ Определение роли пользователя в сессии
- ✅ Поддержка досрочного входа (early=true)

### 5. Обновленные уведомления

**Файл:** `frontend/src/pages/Notifications.tsx`

**Изменения:**

- ✅ Обработка персонализированных ссылок
- ✅ Кнопка "Перейти в комнату ожидания"
- ✅ Автоматическое перенаправление по ссылкам

## Пользовательский сценарий

### 1. Матчинг пользователей

```
1. Пользователи выбирают время и роль
2. Система находит совместимую пару
3. Создается сессия с уникальным ID
4. Генерируются персонализированные ссылки
```

### 2. Уведомления в Telegram

```
1. Оба участника получают уведомления
2. В уведомлении содержится персонализированная ссылка
3. Ссылка ведет на /waiting/{sessionId}
4. Только участники могут перейти по ссылке
```

### 3. Комната ожидания

```
1. Пользователь переходит по ссылке
2. Система проверяет авторизацию
3. Отображается информация о сессии
4. Показывается таймер до начала
5. За 5 минут до начала можно войти
6. Есть кнопка "Войти досрочно" для тестов
```

### 4. Вход в интервью

```
1. Пользователь нажимает "Войти в интервью"
2. Перенаправление на /interview?sessionId={id}
3. Автоматическая загрузка данных сессии
4. Определение роли пользователя
5. Настройка интерфейса под роль
```

## Безопасность

### Авторизация

- ✅ Проверка userId на бэкенде
- ✅ Только участники сессии имеют доступ
- ✅ Автоматическое перенаправление при неавторизованном доступе

### Валидация данных

- ✅ Проверка существования сессии
- ✅ Валидация формата sessionId
- ✅ Обработка ошибок API

### Защита от несанкционированного доступа

- ✅ Проверка роли пользователя в сессии
- ✅ Ограничение доступа к данным сессии
- ✅ Логирование попыток доступа

## API Endpoints

### Получение сессии

```
GET /api/session/:sessionId?userId={userId}
```

**Параметры:**

- `sessionId` - ID сессии
- `userId` - ID пользователя (для авторизации)

**Ответ:**

```json
{
  "id": "session_123",
  "interviewerUserId": "user_1",
  "candidateUserId": "user_2",
  "profession": "frontend",
  "language": "javascript",
  "slotUtc": "2024-01-15T10:00:00Z",
  "status": "scheduled",
  "jitsiRoom": "Super Mock_session_123"
}
```

## Тестирование

### Тестовый скрипт

**Файл:** `test-matching-system.js`

**Запуск:**

```bash
node test-matching-system.js
```

**Что тестирует:**

1. Создание тестовых пользователей
2. Сохранение предпочтений
3. Добавление в очередь
4. Запуск матчинга
5. Проверка персонализированных ссылок
6. Тестирование API получения сессии

## Конфигурация

### Переменные окружения

```env
FRONTEND_URL=http://localhost:5173  # URL фронтенда для генерации ссылок
```

### Настройки времени

- Вход за 5 минут до начала интервью
- Возможность досрочного входа для тестирования
- Таймер обратного отсчета в реальном времени

## Будущие улучшения

### Планируемые функции

- [ ] Уведомления о приближении времени начала
- [ ] Возможность отмены участия
- [ ] Автоматическое завершение сессии по таймауту
- [ ] Статистика использования комнат ожидания
- [ ] Интеграция с календарем

### Технические улучшения

- [ ] Кэширование данных сессий
- [ ] WebSocket уведомления о статусе
- [ ] Аналитика времени ожидания
- [ ] Оптимизация загрузки данных

## Заключение

Система персонализированных ссылок обеспечивает:

- ✅ Безопасный доступ к сессиям
- ✅ Удобный пользовательский опыт
- ✅ Контроль времени входа
- ✅ Интеграцию с существующей системой уведомлений
- ✅ Масштабируемость и расширяемость

Система готова к использованию и может быть легко расширена дополнительной функциональностью.
