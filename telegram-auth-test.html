<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ü§ñ –¢–µ—Å—Ç Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h1>
    
    <div class="test-section">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <p><strong>Bot ID:</strong> <span id="botId">8464088869</span></p>
        <p><strong>Bot Name:</strong> <span id="botName">SuperMock_bot</span></p>
        <p><strong>Domain:</strong> <span id="domain">supermock.ru</span></p>
        <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
    </div>

    <div class="test-section">
        <h2>1. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram Login Widget</h2>
        <div id="telegram-login-widget"></div>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h2>2. OAuth —á–µ—Ä–µ–∑ popup</h2>
        <button onclick="testTelegramOAuth()">–¢–µ—Å—Ç OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
        <div id="oauth-result"></div>
    </div>

    <div class="test-section">
        <h2>3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Frontend)</h2>
        <pre id="env-vars"></pre>
    </div>

    <div class="test-section">
        <h2>4. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h2>
        <div id="diagnostic"></div>
    </div>

    <script>
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π URL
        document.getElementById('currentUrl').textContent = window.location.origin;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        function checkEnvironment() {
            const envVars = {
                'VITE_TELEGRAM_BOT_ID': '8464088869',
                'VITE_TELEGRAM_BOT_NAME': 'SuperMock_bot',
                'Domain': 'supermock.ru'
            };
            
            document.getElementById('env-vars').textContent = JSON.stringify(envVars, null, 2);
        }

        // –°–æ–∑–¥–∞–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram Login Widget
        function createTelegramWidget() {
            const container = document.getElementById('telegram-login-widget');
            
            // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è callback
            window.onTelegramAuth = function(user) {
                document.getElementById('auth-result').innerHTML = 
                    '<div class="success">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</div>' +
                    '<pre>' + JSON.stringify(user, null, 2) + '</pre>';
            };

            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://telegram.org/js/telegram-widget.js?22';
            script.setAttribute('data-telegram-login', 'SuperMock_bot');
            script.setAttribute('data-size', 'large');
            script.setAttribute('data-auth-url', window.location.origin);
            script.setAttribute('data-request-access', 'write');
            script.setAttribute('data-lang', 'ru');
            script.setAttribute('data-onauth', 'onTelegramAuth');
            
            container.appendChild(script);
        }

        // –¢–µ—Å—Ç OAuth —á–µ—Ä–µ–∑ popup
        function testTelegramOAuth() {
            const botId = '8464088869';
            const origin = window.location.origin;
            const authUrl = `https://oauth.telegram.org/auth?bot_id=${botId}&origin=${encodeURIComponent(origin)}&request_access=write&return_to=${encodeURIComponent(origin)}`;
            
            document.getElementById('oauth-result').innerHTML = 
                '<div class="warning">‚è≥ –û—Ç–∫—Ä—ã–≤–∞–µ–º popup –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</div>' +
                '<p>URL: <code>' + authUrl + '</code></p>';
            
            const popup = window.open(authUrl, 'telegram_auth', 'width=500,height=600');
            
            if (!popup) {
                document.getElementById('oauth-result').innerHTML = 
                    '<div class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å popup (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º)</div>';
                return;
            }

            // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç popup
            const handleMessage = (event) => {
                if (event.origin !== 'https://oauth.telegram.org') return;
                
                document.getElementById('oauth-result').innerHTML = 
                    '<div class="success">‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram!</div>' +
                    '<pre>' + JSON.stringify(event.data, null, 2) + '</pre>';
                
                popup.close();
                window.removeEventListener('message', handleMessage);
            };

            window.addEventListener('message', handleMessage);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ popup
            const checkClosed = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkClosed);
                    window.removeEventListener('message', handleMessage);
                }
            }, 1000);
        }

        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        function runDiagnostic() {
            const diagnostic = document.getElementById('diagnostic');
            let issues = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                issues.push('‚ö†Ô∏è Telegram —Ç—Ä–µ–±—É–µ—Ç HTTPS –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–º–µ–Ω
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                issues.push('‚ö†Ô∏è Localhost –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const botId = '8464088869';
            const botName = 'SuperMock_bot';
            
            if (!botId || botId === 'undefined') {
                issues.push('‚ùå VITE_TELEGRAM_BOT_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
            }
            
            if (!botName || botName === 'undefined') {
                issues.push('‚ùå VITE_TELEGRAM_BOT_NAME –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
            }
            
            if (issues.length === 0) {
                diagnostic.innerHTML = '<div class="success">‚úÖ –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ</div>' +
                    '<p>–ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞ –≤ @BotFather</p>';
            } else {
                diagnostic.innerHTML = '<div class="error">–ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:</div><ul>' +
                    issues.map(issue => '<li>' + issue + '</li>').join('') + '</ul>';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkEnvironment();
        createTelegramWidget();
        runDiagnostic();
    </script>
</body>
</html>
