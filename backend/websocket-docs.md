# Документация по WebSocket системе

## Обзор

WebSocket система в приложении обеспечивает обмен данными в реальном времени между клиентами и сервером. Она используется для:

1. Уведомления об изменениях в сессиях
2. Оповещения о выборе ролей
3. Напоминания о необходимости заполнить форму обратной связи
4. Обновления результатов обратной связи в реальном времени

## Архитектура

### Серверная часть

- **Инициализация**: WebSocket сервер инициализируется в `server.js` и использует библиотеку Socket.IO
- **Аутентификация**: Каждое WebSocket соединение аутентифицируется с использованием JWT-токена
- **Комнаты**: Пользователи подписываются на комнаты для получения уведомлений:
  - `user:{userId}` - личная комната пользователя
  - `session:{sessionId}` - комната для конкретной сессии

### Клиентская часть

- **SocketContext**: Контекст React для управления WebSocket соединением
- **useSocket**: Хук для использования WebSocket в компонентах

## События WebSocket

### Серверные события (отправляемые сервером)

1. **session-updated**: Отправляется при изменении статуса сессии

   ```javascript
   {
     sessionId: "идентификатор_сессии",
     session: { /* объект сессии */ }
   }
   ```

2. **role-selected**: Отправляется при выборе роли в сессии

   ```javascript
   {
     sessionId: "идентификатор_сессии",
     userId: "идентификатор_пользователя",
     role: "interviewer|interviewee|observer"
   }
   ```

3. **feedback-required**: Напоминание о необходимости заполнить форму обратной связи

   ```javascript
   {
     sessionId: 'идентификатор_сессии';
   }
   ```

4. **feedback-updated**: Отправляется при создании или обновлении обратной связи
   ```javascript
   {
     sessionId: "идентификатор_сессии",
     feedbackId: "идентификатор_обратной_связи",
     updates: { /* обновленные поля */ },
     newFeedback: { /* новая обратная связь (если создана) */ },
     timestamp: "2025-05-08T01:20:00.000Z"
   }
   ```

### Клиентские события (отправляемые клиентом)

1. **join-session**: Подписка на уведомления для конкретной сессии

   ```javascript
   socket.emit('join-session', sessionId);
   ```

2. **leave-session**: Отписка от уведомлений для конкретной сессии
   ```javascript
   socket.emit('leave-session', sessionId);
   ```

## Использование на клиенте

### Подключение к WebSocket

```jsx
// В App.jsx или другом корневом компоненте
import { SocketProvider } from './contexts/SocketContext';

function App() {
  return (
    <SocketProvider token={userToken}>
      {/* Остальные компоненты */}
    </SocketProvider>
  );
}
```

### Использование хука useSocket

```jsx
import { useSocket } from '../hooks/useSocket';

function MyComponent() {
  const { connected, emit, subscribe, unsubscribe } = useSocket({
    sessionId: 'my-session-id', // Опционально
    events: {
      'session-updated': (data) => {
        console.log('Сессия обновлена:', data);
      },
      'feedback-updated': (data) => {
        console.log('Обратная связь обновлена:', data);
      },
    },
  });

  // Отправка события
  const handleAction = () => {
    emit('custom-event', { data: 'value' });
  };

  return (
    <div>
      <p>Статус соединения: {connected ? 'Подключено' : 'Отключено'}</p>
      <button onClick={handleAction}>Выполнить действие</button>
    </div>
  );
}
```

## Масштабирование

Для масштабирования WebSocket-серверов используется Redis в качестве адаптера для Socket.IO. Это позволяет синхронизировать события между несколькими экземплярами сервера.

Подробные инструкции по настройке Redis для масштабирования см. в файле `redis-setup.md`.

## Отладка

Для отладки WebSocket соединений можно использовать:

1. Консоль браузера (клиентская часть)
2. Логи сервера (серверная часть)

Пример отладки на клиенте:

```javascript
// В компоненте
const { socket } = useSocket();

useEffect(() => {
  if (socket) {
    socket.onAny((event, ...args) => {
      console.log(`Получено событие: ${event}`, args);
    });
  }
}, [socket]);
```

## Безопасность

- Все WebSocket соединения аутентифицируются с использованием JWT-токена
- Пользователи могут подписываться только на те сессии, в которых они участвуют
- Проверка прав доступа выполняется на сервере при обработке событий
