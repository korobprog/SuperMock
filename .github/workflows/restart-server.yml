name: Restart Server

on:
  workflow_dispatch:
    inputs:
      reason:
        description: '–ü—Ä–∏—á–∏–Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞'
        required: true
        default: '–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Docker'

jobs:
  restart-server:
    runs-on: ubuntu-latest
    
    steps:
      - name: Restart production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            echo "üîÑ –ü–ï–†–ï–ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê..."
            echo "–ü—Ä–∏—á–∏–Ω–∞: ${{ github.event.inputs.reason }}"
            echo "–í—Ä–µ–º—è: $(date)"
            echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
            echo "–í–µ—Ç–∫–∞: ${{ github.ref_name }}"
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker stop $(docker ps -aq) 2>/dev/null || true
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
            echo "üìù –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º..."
            mkdir -p /tmp/server-logs
            docker logs supermock-backend > /tmp/server-logs/backend.log 2>&1 || true
            docker logs supermock-frontend > /tmp/server-logs/frontend.log 2>&1 || true
            
            echo "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥!"
            sleep 5
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."
            sudo reboot
