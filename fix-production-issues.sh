#!/bin/bash

# üîß –°–ö–†–ò–ü–¢ –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú –í –ü–†–û–î–ê–ö–®–ï–ù–ï
# –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ production –≤–µ—Ä—Å–∏–∏

echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ..."

# 1. –ö–æ–ø–∏—Ä—É–µ–º –ª–æ–≥–æ—Ç–∏–ø –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ
echo "üñºÔ∏è –ö–æ–ø–∏—Ä—É–µ–º –ª–æ–≥–æ—Ç–∏–ø –≤ frontend/public..."
mkdir -p frontend/public
cp public/logo_main.png frontend/public/
echo "‚úÖ –õ–æ–≥–æ—Ç–∏–ø —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
if [ -f "production.env" ]; then
    echo "‚úÖ production.env –Ω–∞–π–¥–µ–Ω"
    echo "üìã VITE_API_URL: $(grep VITE_API_URL production.env | cut -d'=' -f2)"
    
    # –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    echo "üìù –ö–æ–ø–∏—Ä—É–µ–º production.env –≤ .env..."
    cp production.env .env
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚ùå production.env –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# 3. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."
ssh -i ~/.ssh/timeweb_vps_key root@217.198.6.238 "cd /opt/mockmate && cp production.env .env && docker compose -f docker-compose.prod.yml build --no-cache frontend && docker compose -f docker-compose.prod.yml up -d frontend"

# 4. –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
ssh -i ~/.ssh/timeweb_vps_key root@217.198.6.238 "cd /opt/mockmate && docker exec supermock-backend npx prisma migrate deploy"

# 5. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo "üìö –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
ssh -i ~/.ssh/timeweb_vps_key root@217.198.6.238 "cd /opt/mockmate && docker cp materials supermock-backend:/app/ && docker exec supermock-backend node backend/scripts/load-materials.js"

# 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫–µ–Ω–¥
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫–µ–Ω–¥..."
ssh -i ~/.ssh/timeweb_vps_key root@217.198.6.238 "cd /opt/mockmate && docker compose -f docker-compose.prod.yml restart backend"

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
ssh -i ~/.ssh/timeweb_vps_key root@217.198.6.238 "cd /opt/mockmate && docker compose -f docker-compose.prod.yml ps"

# 8. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API..."
if curl -s https://api.supermock.ru/api/health > /dev/null; then
    echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS"
else
    echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS"
fi

# 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤..."
if curl -s "https://api.supermock.ru/api/materials?profession=frontend&language=ru&limit=1" > /dev/null; then
    echo "‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã"
else
    echo "‚ùå –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
fi

# 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ª–æ–≥–æ—Ç–∏–ø–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ª–æ–≥–æ—Ç–∏–ø–∞..."
if curl -s https://supermock.ru/logo_main.png > /dev/null; then
    echo "‚úÖ –õ–æ–≥–æ—Ç–∏–ø –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ùå –õ–æ–≥–æ—Ç–∏–ø –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# 11. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ..."
ssh -i ~/.ssh/timeweb_vps_key root@217.198.6.238 "docker exec supermock-frontend env | grep VITE_API_URL"

echo ""
echo "üéâ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
echo ""
echo "üìã –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:"
echo "   ‚úÖ –õ–æ–≥–æ—Ç–∏–ø —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ"
echo "   ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
echo "   ‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏"
echo "   ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
echo "   ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"
echo "   ‚úÖ API –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ HTTPS"
echo "   ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤"
echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://supermock.ru"
