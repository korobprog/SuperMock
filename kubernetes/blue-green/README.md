# Blue-Green Deployment для SuperMock

Эта директория содержит конфигурацию для реализации blue-green deployment в Kubernetes для приложения SuperMock.

## Что такое Blue-Green Deployment?

Blue-Green Deployment - это стратегия развертывания, которая позволяет обновлять приложения с минимальным временем простоя и риском. Основная идея заключается в поддержании двух идентичных окружений (blue и green), где только одно из них активно и обслуживает пользовательский трафик.

При обновлении приложения:

1. Новая версия развертывается в неактивном окружении
2. Проводится тестирование новой версии
3. Трафик переключается с активного окружения на неактивное
4. Предыдущее активное окружение становится неактивным и готовым для следующего обновления

## Преимущества Blue-Green Deployment

- **Нулевое время простоя**: Пользователи не замечают переключения между версиями
- **Быстрый откат**: В случае проблем можно мгновенно вернуться к предыдущей версии
- **Изолированное тестирование**: Новая версия может быть протестирована в изолированной среде
- **Постепенное переключение**: Поддержка canary deployment для постепенного переключения трафика

## Структура директории

- `backend-blue.yaml` - Deployment для blue версии приложения
- `backend-green.yaml` - Deployment для green версии приложения
- `service.yaml` - Service для маршрутизации трафика между blue и green версиями
- `configmap.yaml` - ConfigMap с настройками для blue-green deployment
- `kustomization.yaml` - Kustomize конфигурация для объединения всех ресурсов
- `switch-version.sh` - Скрипт для переключения между blue и green версиями
- `deploy-blue-green.sh` - Скрипт для развертывания blue-green конфигурации

## Начало работы

### Предварительные требования

- Kubernetes кластер
- kubectl настроен для работы с кластером
- Docker registry с доступом на запись
- jq (для работы скриптов)

### Развертывание

1. Установите переменные окружения для доступа к Docker registry:

```bash
export DOCKER_USERNAME=your-docker-username
export DOCKER_PASSWORD=your-docker-password
```

2. Запустите скрипт развертывания:

```bash
chmod +x deploy-blue-green.sh
./deploy-blue-green.sh
```

По умолчанию, начальной активной версией будет blue. Если вы хотите начать с green версии, используйте:

```bash
./deploy-blue-green.sh --initial-version=green
```

### Переключение между версиями

Для переключения между версиями используйте скрипт `switch-version.sh`:

```bash
# Переключение на blue версию
./switch-version.sh blue

# Переключение на green версию
./switch-version.sh green
```

### Canary Deployment

Для постепенного переключения трафика (canary deployment) используйте параметр `--canary`:

```bash
# Направить 20% трафика на green версию
./switch-version.sh green --canary=20
```

## Мониторинг и автоматический откат

Скрипт `switch-version.sh` включает функциональность мониторинга и автоматического отката. После переключения на новую версию, скрипт будет мониторить метрики производительности и ошибок. Если метрики превысят пороговые значения, будет выполнен автоматический откат на предыдущую версию.

Пороговые значения и другие параметры настраиваются в ConfigMap `blue-green-config`.

## Интеграция с CI/CD

Для интеграции blue-green deployment с CI/CD пайплайном, добавьте следующие шаги в ваш пайплайн:

1. Сборка и публикация Docker образа с тегом `blue` или `green` (в зависимости от текущей неактивной версии)
2. Обновление неактивного Deployment
3. Тестирование новой версии через сервис `backend-preview`
4. Переключение трафика на новую версию с помощью скрипта `switch-version.sh`

## Настройка параметров

Параметры blue-green deployment настраиваются в ConfigMap `blue-green-config`:

- `ACTIVE_VERSION` - Текущая активная версия (blue или green)
- `ENABLE_CANARY` - Включение/выключение canary deployment
- `CANARY_PERCENTAGE` - Процент трафика для canary deployment
- `ROLLBACK_TIMEOUT_SECONDS` - Таймаут для автоматического отката
- `ERROR_THRESHOLD_PERCENTAGE` - Пороговое значение ошибок для автоматического отката
- `LATENCY_THRESHOLD_MS` - Пороговое значение задержки для автоматического отката
- `HEALTH_CHECK_*` - Параметры проверки здоровья

## Дальнейшие улучшения

- Интеграция с HashiCorp Vault для управления секретами
- Реализация canary deployment с использованием Istio или другого сервисного меша
- Автоматизация процесса определения текущей активной/неактивной версии
- Добавление метрик и алертов для мониторинга процесса развертывания
